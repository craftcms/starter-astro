---
import Layout from '../../layouts/Layout.astro';
import { craftClient } from '../../lib/craft';
import { getPreviewStatus } from '../../lib/preview';
import { GUESTBOOK_QUERY } from '../../queries/guestbook.mjs';
import PostList from '../../components/PostList.vue';
import PostForm from '../../components/PostForm.vue';

const preview = getPreviewStatus(Astro.url);

const data = await craftClient.query(GUESTBOOK_QUERY, {}, {
  preview: preview.isPreview,
  token: preview.token
});

const content = data?.guestbookEntries?.[0];
---

<Layout title={content?.title || 'Guestbook'}>
  <div>
    <header class="container mx-auto pt-12 pb-6 px-2">
      <h1 class="font-bold text-4xl sm:text-6xl lg:text-9xl">
        {content?.title}
      </h1>
      {content?.pageSubheading && (
        <p class="mt-4 text-2xl">{content.pageSubheading}</p>
      )}
    </header>

    {content?.pageContent && (
      <section class="page__content">
        <div 
          class="container mx-auto py-12 px-2 prose prose-slate lg:prose-xl"
          set:html={content.pageContent}
        />
      </section>
    )}

    <div class="container mx-auto px-2 sm:grid gap-6 grid-cols-2">
      <section class="mb-12">
        <PostList 
          client:load
          previewToken={preview.token}
        />
      </section>

      <section>
        <div class="bg-slate-200 p-6 mb-9 rounded">
          <h2 class="font-bold text-3xl mb-4">Post an entry</h2>
          <PostForm 
            client:load
            authorId={content?.authorId}
          />
        </div>
      </section>
    </div>
  </div>
</Layout>