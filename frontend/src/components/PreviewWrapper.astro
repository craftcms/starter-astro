---
import Content from './Content.astro';
import { craftClient } from '../lib/craft';

const { query, initialData } = Astro.props;
const { token, 'x-craft-live-preview': isPreview } = Astro.url.searchParams;

let pageData = initialData;

if (isPreview && token) {
  try {
    const previewData = await craftClient.query(query, {}, {
      preview: true,
      token
    });
    pageData = previewData?.entry || initialData;
  } catch (error) {
    console.error('Preview fetch error:', error);
  }
}
---

<Content pageData={pageData} />

<script>
  // Client-side preview refresh
  if (document.querySelector('.preview-banner')) {
    const refreshPreview = () => {
      window.location.reload();
    };

    window.addEventListener('message', (event) => {
      if (event.data === 'preview:refresh') {
        refreshPreview();
      }
    });
  }
</script> 