---
import Content from './Content.astro';
import PreviewBanner from './PreviewBanner.vue';
import { craftClient } from '../lib/craft';

const { query, initialData } = Astro.props;
const { token, 'x-craft-live-preview': isPreview } = Astro.url.searchParams;

let pageData = initialData;

if (isPreview && token) {
  try {
    const previewData = await craftClient.query(query, {}, {
      preview: true,
      token
    });
    pageData = previewData?.entry || initialData;
  } catch (error) {
    console.error('Preview fetch error:', error);
  }
}
---

{isPreview && <PreviewBanner client:load uri={pageData.uri} />}
<Content pageData={pageData} />

<style>
  .preview-banner {
    background: #374151;
    color: white;
    padding: 0.5rem;
    text-align: center;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 50;
  }
  .preview-banner a {
    color: #93c5fd;
    text-decoration: underline;
  }
</style>

<script>
  // Client-side preview refresh
  if (document.querySelector('.preview-banner')) {
    const refreshPreview = () => {
      window.location.reload();
    };

    window.addEventListener('message', (event) => {
      if (event.data === 'preview:refresh') {
        refreshPreview();
      }
    });
  }
</script> 